#!/bin/bash
# é‡æ–°æ„å»ºå¹¶éƒ¨ç½²è„šæœ¬ï¼ˆä¿®å¤æ•°æ®åº“é…ç½®é—®é¢˜ï¼‰

set -e

echo "========================================"
echo "ğŸ”§ é‡æ–°æ„å»ºå¹¶éƒ¨ç½² YK-VOS"
echo "========================================"
echo ""

# åœæ­¢æ‰€æœ‰å®¹å™¨
echo "ğŸ“‹ æ­¥éª¤ 1: åœæ­¢æ‰€æœ‰å®¹å™¨"
echo "----------------------------------------"
docker-compose down
echo "âœ… å®¹å™¨å·²åœæ­¢"
echo ""

# æ¸…ç†æ—§çš„æ•°æ®åº“æ•°æ®ï¼ˆå¯é€‰ï¼Œå¦‚æœéœ€è¦ä¿ç•™æ•°æ®è¯·è·³è¿‡ï¼‰
read -p "æ˜¯å¦æ¸…ç†æ—§çš„æ•°æ®åº“æ•°æ®ï¼Ÿ(y/N): " -n 1 -r
echo
if [[ $REPLY =~ ^[Yy]$ ]]; then
    echo "ğŸ“‹ æ­¥éª¤ 2: æ¸…ç†æ•°æ®åº“æ•°æ®"
    echo "----------------------------------------"
    rm -rf data/postgres
    mkdir -p data/postgres
    echo "âœ… æ•°æ®åº“æ•°æ®å·²æ¸…ç†"
else
    echo "ğŸ“‹ æ­¥éª¤ 2: ä¿ç•™ç°æœ‰æ•°æ®åº“æ•°æ®"
    echo "----------------------------------------"
    echo "âš ï¸  è·³è¿‡æ•°æ®æ¸…ç†"
fi
echo ""

# é‡æ–°æ„å»ºåŸºç¡€é•œåƒ
echo "ğŸ“‹ æ­¥éª¤ 3: é‡æ–°æ„å»ºåŸºç¡€é•œåƒ"
echo "----------------------------------------"
echo "è¿™å¯èƒ½éœ€è¦å‡ åˆ†é’Ÿæ—¶é—´..."
docker-compose -f docker-compose.base.yaml build --no-cache
echo "âœ… åŸºç¡€é•œåƒæ„å»ºå®Œæˆ"
echo ""

# å¯åŠ¨æ‰€æœ‰æœåŠ¡
echo "ğŸ“‹ æ­¥éª¤ 4: å¯åŠ¨æ‰€æœ‰æœåŠ¡"
echo "----------------------------------------"
docker-compose up -d
echo "âœ… æœåŠ¡å·²å¯åŠ¨"
echo ""

# ç­‰å¾…æœåŠ¡å¯åŠ¨
echo "ğŸ“‹ æ­¥éª¤ 5: ç­‰å¾…æœåŠ¡å¯åŠ¨"
echo "----------------------------------------"
echo "ç­‰å¾… 30 ç§’..."
sleep 30
echo ""

# æ£€æŸ¥æœåŠ¡çŠ¶æ€
echo "ğŸ“‹ æ­¥éª¤ 6: æ£€æŸ¥æœåŠ¡çŠ¶æ€"
echo "----------------------------------------"
docker-compose ps
echo ""

# æŸ¥çœ‹åç«¯æ—¥å¿—
echo "ğŸ“‹ æ­¥éª¤ 7: åç«¯æ—¥å¿—ï¼ˆæœ€è¿‘ 30 è¡Œï¼‰"
echo "----------------------------------------"
docker-compose logs --tail=30 backend
echo ""

# æ£€æŸ¥æ•°æ®åº“è¿æ¥
echo "ğŸ“‹ æ­¥éª¤ 8: éªŒè¯æ•°æ®åº“"
echo "----------------------------------------"
echo "æ£€æŸ¥æ•°æ®åº“è¿æ¥..."
if docker-compose exec postgres psql -U vos_user -d vosadmin -c "SELECT 'Database OK' as status;" 2>/dev/null; then
    echo "âœ… æ•°æ®åº“è¿æ¥æˆåŠŸ"
    echo ""
    echo "æŸ¥çœ‹æ•°æ®åº“è¡¨..."
    docker-compose exec postgres psql -U vos_user -d vosadmin -c "\dt"
else
    echo "âŒ æ•°æ®åº“è¿æ¥å¤±è´¥"
fi
echo ""

echo "========================================"
echo "âœ… éƒ¨ç½²å®Œæˆï¼"
echo "========================================"
echo ""
echo "ğŸŒ è®¿é—®åœ°å€ï¼š"
echo "   å‰ç«¯: http://your-server:3000"
echo "   åç«¯: http://your-server:8000"
echo ""
echo "ğŸ”‘ é»˜è®¤ç®¡ç†å‘˜è´¦æˆ·ï¼š"
echo "   ç”¨æˆ·å: admin"
echo "   å¯†ç : admin123"
echo ""
echo "ğŸ“Š æŸ¥çœ‹å®æ—¶æ—¥å¿—ï¼š"
echo "   docker-compose logs -f backend"
echo ""

